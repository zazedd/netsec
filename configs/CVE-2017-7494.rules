alert tcp any any -> $HOME_NET 445 ( \
  msg:"ET EXPLOIT Samba Arbitrary Module Loading Vulnerability M2 (NT Create AndX .so) (CVE-2017-7494)";  \
  flow:to_server,established;  \
  content:"SMB";  \
  offset:5; \
  depth:3; \
  content:"|05 00|"; \
  distance:8; \
  within:2; \
  content:"|00 2e 00 73 00 6f 00|"; \
  distance:0; \
  fast_pattern; \
  isdataat:!1,relative; \
  metadata: former_category EXPLOIT; \
  reference:cve,2017-7494; \
  classtype:attempted-admin; \
  sid:1000001; \
  rev:1; \
  metadata:affected_product Linux, attack_target Server, deployment Perimeter, deployment Internal, signature_severity Major, created_at 2017_06_16, performance_impact Moderate, updated_at 2017_06_16; \
)

alert tcp any any -> $HOME_NET 445 (msg:"ET EXPLOIT Samba Arbitrary Module Loading Vulnerability (.so file write to share) (CVE-2017-7494)"; \
  flow:to_server,established; \
  content:"SMB|2d 00|"; \
  offset:5; \
  depth:5; \
  content:"|00 00|"; \
  distance:1; \
  within:2; \
  content:"|12 00|"; \
  distance:40; \
  within:2; \
  content:"|2e|so|00|"; \
  fast_pattern; \
  distance:16; \
  metadata: former_category EXPLOIT; \
  reference:cve,2017-7494; \
  reference:url,github.com/rapid7/metasploit-framework/pull/8450; \
  classtype:attempted-admin; \
  sid:1000002; \
  rev:1; \
  metadata:attack_target SMB_Server, deployment Datacenter, signature_severity Critical, created_at 2017_05_25, performance_impact Low, updated_at 2017_05_25; \
)

alert tcp any any -> $HOME_NET 445 (msg:"ET EXPLOIT Samba Arbitrary Module Loading Vulnerability (NT Create AndX .so) (CVE-2017-7494)"; \
  flow:to_server,established; \
  content:"SMB|a2 00|"; \
  offset:5; \
  depth:5; \
  content:"|00 00|"; \
  distance:1; \
  within:2; \
  content:"|2e|so|00|"; \
  fast_pattern; \
  distance:16; \
  metadata: former_category EXPLOIT; \
  reference:cve,2017-7494; \
  reference:url,github.com/rapid7/metasploit-framework/pull/8450; \
  classtype:attempted-admin; \
  sid:1000003; \
  rev:1; \
  metadata:attack_target SMB_Server, deployment Datacenter, signature_severity Critical, created_at 2017_05_25, performance_impact Low, updated_at 2017_05_25; \
)

alert tcp any any -> $HOME_NET 445 (msg:"SERVER-SAMBA Samba is_known_pipe arbitrary module load code execution attempt"; flow:to_server,established; flowbits:isset,smb.tree.connect.ipc; content:"|FF|SMB|A2 00 00 00 00|"; depth:9; offset:4; byte_test:2,=,0,1,relative,little,bitmask 0x8000; byte_extract:2,72,len,relative,little; content:"/"; within:1; content:"/"; within:len; distance:1; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, ruleset community, service netbios-ssn; reference:cve,2017-7494; reference:url,www.samba.org/samba/security/CVE-2017-7494.html; classtype:attempted-user; sid:43004; rev:5;)

alert tcp any any -> $HOME_NET 445 (msg:"Suspicious .so file transfer to Samba server"; \
  content:".so"; \
  nocase; \
  flow:to_server,established; \
  sid:1000004; \
  rev:1; \
)
